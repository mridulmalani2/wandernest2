// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum StudentStatus {
  PENDING_APPROVAL
  APPROVED
  SUSPENDED
}

enum RequestStatus {
  PENDING
  MATCHED
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum AdminRole {
  SUPER_ADMIN
  MODERATOR
  SUPPORT
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

// ============================================
// MODELS
// ============================================

model Student {
  id                String   @id @default(cuid())
  email             String   @unique
  emailVerified     Boolean  @default(false)
  googleId          String?  @unique  // Now optional - supports both Google OAuth and email verification
  name              String?  // Optional until onboarding is completed

  // Personal Details
  dateOfBirth       DateTime?
  gender            String?  // male, female, prefer_not_to_say
  nationality       String?
  phoneNumber       String?
  city              String?
  campus            String?  // Specific campus location

  // Academic Details
  institute         String?  // University name
  programDegree     String?  // e.g., "MSc Computer Science", "BA Economics"
  yearOfStudy       String?  // e.g., "1st year MSc", "2nd year Undergrad"
  expectedGraduation String? // e.g., "2025", "June 2026"

  // Identity Verification
  studentIdUrl      String?  // Student ID card upload
  studentIdExpiry   DateTime?
  governmentIdUrl   String?  // Passport or national ID
  governmentIdExpiry DateTime?
  selfieUrl         String?  // Selfie for verification
  profilePhotoUrl   String?  // Public profile photo
  verificationConsent Boolean @default(false)
  documentsOwnedConfirmation Boolean @default(false)

  // Profile Information
  bio               String?  @db.Text
  skills            String[] @default([])  // Skills or areas of interest
  preferredGuideStyle String? // friendly, structured, energetic, etc.

  // Legacy field (kept for backward compatibility)
  idCardUrl         String?

  coverLetter       String?  @db.Text
  languages         String[] @default([])  // Array of language codes
  interests         String[] @default([])  // Array of interest tags

  // Service Preferences
  servicesOffered   String[] @default([])  // walk-around, itinerary, cultural, recommendations
  hourlyRate        Float?
  onlineServicesAvailable Boolean @default(false)

  // Availability & Scheduling
  timezone          String?  // e.g., "Europe/Paris", "Europe/London"
  preferredDurations String[] @default([])  // e.g., ["1 hour", "2 hours", "3-4 hours"]
  unavailableDates  Json?    // Array of date ranges when unavailable

  // Safety & Compliance
  termsAccepted     Boolean  @default(false)
  safetyGuidelinesAccepted Boolean @default(false)
  independentGuideAcknowledged Boolean @default(false)
  emergencyContactName String?
  emergencyContactPhone String?

  // System Fields
  status            StudentStatus @default(PENDING_APPROVAL)
  profileCompleteness Float? // 0-100 percentage
  priceRange        Json?    // {min: number, max: number} - legacy field

  // Metrics
  tripsHosted       Int      @default(0)
  averageRating     Float?
  noShowCount       Int      @default(0)
  acceptanceRate    Float?
  reliabilityBadge  String?  // bronze, silver, gold

  availability      StudentAvailability[]
  unavailabilityExceptions UnavailabilityException[]
  requestSelections RequestSelection[]
  reviews           Review[]
  reports           Report[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([city])
  @@index([nationality])
  @@index([status])
  @@index([email])
  @@index([city, status])
  @@index([status, averageRating])
  @@index([email, status])
}

model StudentAvailability {
  id          String   @id @default(cuid())
  studentId   String
  dayOfWeek   Int      // 0-6 (Sunday-Saturday)
  startTime   String   // "09:00"
  endTime     String   // "17:00"
  note        String?  // "Not available during exams"

  student     Student  @relation(fields: [studentId], references: [id])

  @@index([studentId])
}

model UnavailabilityException {
  id          String   @id @default(cuid())
  studentId   String
  date        DateTime // Specific date unavailable
  reason      String?  // Optional reason

  student     Student  @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([date])
}

model Tourist {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String?
  image             String?  // Profile picture from Google
  googleId          String?  @unique  // Google OAuth ID

  // Relations
  requests          TouristRequest[]
  payments          Payment[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([email])
  @@index([googleId])
}

model TouristRequest {
  id                String   @id @default(cuid())
  email             String
  emailVerified     Boolean  @default(false)
  verificationCode  String?

  // Link to authenticated tourist (optional for backward compatibility)
  touristId         String?
  tourist           Tourist? @relation(fields: [touristId], references: [id])

  // Trip Details
  city              String
  dates             Json     // {start: Date, end: Date} or single date
  preferredTime     String   // "morning", "afternoon", "evening"
  numberOfGuests    Int
  groupType         String   // family, friends, solo, business
  accessibilityNeeds String?

  // Matching Criteria
  preferredNationality String?
  preferredLanguages   String[]
  preferredGender      String?  // male, female, no_preference
  serviceType          String   // itinerary_help, guided_experience
  interests            String[]
  budget               Float?

  // Contact
  phone             String?
  whatsapp          String?
  contactMethod     String   // email, phone, whatsapp
  meetingPreference String   // hotel_pickup, public_place, virtual
  tripNotes         String?  @db.Text

  status            RequestStatus @default(PENDING)
  assignedStudentId String?

  selections        RequestSelection[]
  review            Review?
  payments          Payment[]

  createdAt         DateTime @default(now())
  expiresAt         DateTime

  @@index([city])
  @@index([status])
  @@index([email])
  @@index([touristId])
  @@index([city, status])
  @@index([status, createdAt])
}

model RequestSelection {
  id                String         @id @default(cuid())
  requestId         String
  studentId         String
  status            String         // pending, accepted, rejected
  message           String?        @db.Text
  pricePaid         Float?         // Actual price paid for the service

  request           TouristRequest @relation(fields: [requestId], references: [id])
  student           Student        @relation(fields: [studentId], references: [id])

  createdAt         DateTime       @default(now())
  acceptedAt        DateTime?      // For analytics - response time calculation

  @@index([requestId])
  @@index([studentId])
  @@index([status])
  @@index([requestId, status])
  @@index([studentId, status])
}

model Review {
  id                String         @id @default(cuid())
  requestId         String         @unique
  studentId         String
  rating            Int            // 1-5 (required)
  text              String?        @db.Text // optional, max 500 chars (enforced in app layer)
  attributes        String[]       // predefined list of attributes
  noShow            Boolean        @default(false)
  pricePaid         Float?         // optional
  isAnonymous       Boolean        @default(false)

  request           TouristRequest @relation(fields: [requestId], references: [id])
  student           Student        @relation(fields: [studentId], references: [id])

  createdAt         DateTime       @default(now())

  @@index([studentId])
  @@index([createdAt])
}

model Report {
  id                String   @id @default(cuid())
  studentId         String
  reason            String
  description       String   @db.Text
  status            String   // pending, reviewed, resolved

  student           Student  @relation(fields: [studentId], references: [id])

  createdAt         DateTime @default(now())

  @@index([studentId])
  @@index([status])
}

model Admin {
  id                String   @id @default(cuid())
  email             String   @unique
  passwordHash      String
  name              String
  role              AdminRole @default(MODERATOR)
  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([email])
  @@index([role])
}

model TouristSession {
  id                String   @id @default(cuid())
  email             String
  verificationCode  String
  token             String?  @unique
  isVerified        Boolean  @default(false)
  expiresAt         DateTime

  createdAt         DateTime @default(now())

  @@index([email])
  @@index([token])
}

model StudentSession {
  id                String   @id @default(cuid())
  email             String
  studentId         String?  // Links to Student model after onboarding
  token             String   @unique
  isVerified        Boolean  @default(false)
  expiresAt         DateTime

  createdAt         DateTime @default(now())

  @@index([email])
  @@index([token])
  @@index([studentId])
}

// ============================================
// NEXTAUTH MODELS (for Student Google OAuth - Legacy)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  userType      String    @default("tourist")  // "tourist" or "student" (legacy)
  touristId     String?   // Link to Tourist model
  accounts      Account[]
  sessions      Session[]

  @@index([email])
  @@index([touristId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Payment {
  id                String        @id @default(cuid())
  touristId         String?
  tourist           Tourist?      @relation(fields: [touristId], references: [id])
  requestId         String?       // Optional: link to specific tourist request
  request           TouristRequest? @relation(fields: [requestId], references: [id])

  // Payment Details
  amount            Float         // in INR
  currency          String        @default("INR")
  status            PaymentStatus @default(PENDING)

  // Razorpay Details
  razorpayOrderId   String        @unique
  razorpayPaymentId String?       @unique
  razorpaySignature String?

  // Metadata
  email             String
  phone             String?
  description       String        @default("Discovery Fee - TourWiseCo")

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([touristId])
  @@index([requestId])
  @@index([status])
  @@index([email])
}

model ContactMessage {
  id          String   @id @default(cuid())
  name        String
  email       String
  phone       String?
  message     String   @db.Text
  fileUrl     String?  // URL to uploaded file (if any)
  fileName    String?  // Original filename
  status      String   @default("pending") // pending, read, replied

  createdAt   DateTime @default(now())

  @@index([email])
  @@index([status])
  @@index([createdAt])
}
